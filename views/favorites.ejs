<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/head.ejs') %>
  <title>My Favorite Recipes</title>
</head>

<body>
  <%- include('partials/nav.ejs') %>

  <div class="container mt-4" style="max-width: 980px;">
    
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h2 class="m-0">My Favorite Recipes</h2>

      <%
        const sortParam = typeof sort !== 'undefined' ? sort : 'name';
      %>

      <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
          Sort
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li>
            <a class="dropdown-item <%= sortParam === 'calories' ? 'active' : '' %>" href="?sort=calories">
              Calories
            </a>
          </li>
          <li>
            <a class="dropdown-item <%= sortParam === 'protein' ? 'active' : '' %>" href="?sort=protein">
              Protein
            </a>
          </li>
          <li>
            <a class="dropdown-item <%= sortParam === 'name' ? 'active' : '' %>" href="?sort=name">
              Name
            </a>
          </li>
        </ul>
      </div>
    </div>

    <!-- different for guests vs users that are logged in. -->
    <% if (!isAuthenticated) { %>
      <div class="alert alert-warning mt-3">
        You’re currently viewing <strong>sample favorite meals</strong>.
        <br>
        <a href="/create" class="alert-link">Create an account</a> or
        <a href="/login" class="alert-link">log in</a> to save your own favorites.
      </div>
    <% } else { %>
      <div class="alert alert-success mt-3">
        Logged in as <strong><%= userName %></strong>. These are your saved favorites.
      </div>
    <% } %>

    <%
      // Sample favorites to show ONLY for guests
      const sampleFavs = [
        {
          idMeal: '52771',
          strMeal: 'Spaghetti Bolognese',
          strMealThumb: 'https://www.themealdb.com/images/media/meals/ustsqw1468250014.jpg'
        },
        {
          idMeal: '52818',
          strMeal: 'Grilled Chicken Salad',
          strMealThumb: 'https://www.themealdb.com/images/media/meals/1529446352.jpg'
        },
        {
          idMeal: '53065',
          strMeal: 'Veggie Stir Fry',
          strMealThumb: 'https://www.themealdb.com/images/media/meals/wai9bw1619788844.jpg'
        },
        {
          idMeal: '52959',
          strMeal: 'Beef & Broccoli',
          strMealThumb: 'https://www.themealdb.com/images/media/meals/1529444830.jpg'
        }
      ];

      let favs;
      let mode; // 'guest-sample' or 'user-db'

      if (!isAuthenticated) {
        // GUEST: always show sample favorites
        favs = sampleFavs;
        mode = 'guest-sample';
      } else {
        // LOGGED IN: use DB favorites if provided, otherwise empty
        if (
          typeof favorites !== 'undefined' &&
          Array.isArray(favorites) &&
          favorites.length > 0
        ) {
          favs = favorites;
        } else {
          favs = [];
        }
        mode = 'user-db';
      }
    %>

    <ul class="list-group shadow-sm mt-3">
      <% if (mode === 'user-db' && favs.length === 0) { %>
        <!-- Logged in, but no favorites yet -->
        <li class="list-group-item text-center text-muted">
          You don’t have any favorites yet. Browse recipes and add some!
        </li>
      <% } else { %>
        <% favs.forEach(f => { %>
          <li class="list-group-item d-flex align-items-center">
            <% if (mode === 'guest-sample') { %>

              <img src="<%= f.strMealThumb %>" alt="" class="rounded me-3"
                   style="width:64px;height:64px;object-fit:cover;">
              <div class="flex-grow-1">
                <div class="fw-semibold"><%= f.strMeal %></div>
              </div>

              <a class="btn btn-sm btn-outline-success me-2"
                 href="https://www.themealdb.com/meal/<%= f.idMeal %>"
                 target="_blank" rel="noopener">
                View
              </a>

              <!-- Remove disabled for guests -->
              <button class="btn btn-sm btn-outline-danger" disabled title="Login required">
                Remove
              </button>

            <% } else { %>

              <img src="<%= f.imageUrl %>" alt="" class="rounded me-3"
                   style="width:64px;height:64px;object-fit:cover;">
              <div class="flex-grow-1">
                <div class="fw-semibold"><%= f.title %></div>

                <% if (f.calories != null || f.protein != null) { %>
                  <div class="text-muted small">
                    <% if (f.calories != null) { %>
                      <%= f.calories %> kcal
                    <% } %>
                    <% if (f.protein != null) { %>
                      &middot; <%= f.protein %> g protein
                    <% } %>
                  </div>
                <% } %>
              </div>



              <form method="POST" action="/favorites/remove" class="m-0 ms-2">
                <input type="hidden" name="recipeId" value="<%= f.recipeID %>">
                <button class="btn btn-sm btn-outline-danger">Remove</button>
              </form>
            <% } %>
          </li>
        <% }) %>
      <% } %>
    </ul>
  </div>

  <%- include('partials/foot.ejs') %>
</body>
</html>
