<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('partials/head.ejs') %>
  <title>My Favorite Recipes</title>
</head>

<body>
  <%- include('partials/nav.ejs') %>

  <div class="container mt-4" style="max-width: 980px;">

    <div class="d-flex align-items-center justify-content-between mb-3">
      <h2 class="m-0">My Favorite Recipes</h2>

      <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
          Sort
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li>
            <a class="dropdown-item <%= sort === 'calories' ? 'active' : '' %>" href="?sort=calories">
              Calories
            </a>
          </li>
          <li>
            <a class="dropdown-item <%= sort === 'protein' ? 'active' : '' %>" href="?sort=protein">
              Protein
            </a>
          </li>
          <li>
            <a class="dropdown-item <%= sort === 'name' ? 'active' : '' %>" href="?sort=name">
              Name
            </a>
          </li>
        </ul>
      </div>
    </div>

    <!-- Top alert: guest vs logged in -->
    <% if (!isAuthenticated) { %>
      <div class="alert alert-warning mt-3">
        You’re currently viewing <strong>sample favorite meals</strong>.
        <br>
        <a href="/create" class="alert-link">Create an account</a> or
        <a href="/login" class="alert-link">log in</a> to save your own favorites.
      </div>
    <% } else { %>
      <div class="alert alert-success mt-3">
        Logged in as <strong><%= userName %></strong>. These are your saved favorites.
      </div>
    <% } %>

    <%
      // Sample favorites for GUESTS only (ThemealDB data)
      const sampleFavs = [
        {
          idMeal: '52771',
          strMeal: 'Spaghetti Bolognese',
          strMealThumb: 'https://www.themealdb.com/images/media/meals/ustsqw1468250014.jpg'
        },
        {
          idMeal: '52818',
          strMeal: 'Grilled Chicken Salad',
          strMealThumb: 'https://www.themealdb.com/images/media/meals/1529446352.jpg'
        },
        {
          idMeal: '53065',
          strMeal: 'Veggie Stir Fry',
          strMealThumb: 'https://www.themealdb.com/images/media/meals/wai9bw1619788844.jpg'
        },
        {
          idMeal: '52959',
          strMeal: 'Beef & Broccoli',
          strMealThumb: 'https://www.themealdb.com/images/media/meals/1529444830.jpg'
        }
      ];

      let favs;
      if (!isAuthenticated) {
        // Guest: always show sampleFavs
        favs = sampleFavs;
      } else {
        // Logged in: use favorites from DB (route passes `favorites`)
        favs = (Array.isArray(favorites) && favorites.length) ? favorites : [];
      }
    %>

    <ul class="list-group shadow-sm mt-3">
      <% if (isAuthenticated && favs.length === 0) { %>
        <!-- Logged in but no favorites yet -->
        <li class="list-group-item text-center text-muted">
          You don’t have any favorites yet. Browse recipes and add some!
        </li>
      <% } else { %>
        <% favs.forEach(f => { %>
          <li class="list-group-item d-flex align-items-center">

            <% if (!isAuthenticated) { %>
              <!-- Guest: ThemealDB sample -->
              <img src="<%= f.strMealThumb %>" alt="" class="rounded me-3"
                   style="width:64px;height:64px;object-fit:cover;">
              <div class="flex-grow-1">
                <div class="fw-semibold"><%= f.strMeal %></div>
              </div>

              <a class="btn btn-sm btn-outline-success me-2"
                 href="https://www.themealdb.com/meal/<%= f.idMeal %>"
                 target="_blank" rel="noopener">
                View
              </a>

              <button class="btn btn-sm btn-outline-danger" disabled title="Login required">
                Remove
              </button>
            <% } else { %>
              
              <img src="<%= f.imageUrl %>" alt="" class="rounded me-3"
                   style="width:64px;height:64px;object-fit:cover;">

              <div class="flex-grow-1">
                <div class="fw-semibold"><%= f.title %></div>
                <small class="text-muted">
                  <% if (f.calories != null) { %>Calories: <%= f.calories %><% } %>
                  <% if (f.protein != null) { %> · Protein: <%= f.protein %> g<% } %>
                </small>
              </div>

              <form method="POST" action="/favorites/remove" class="m-0">
                <input type="hidden" name="recipeId" value="<%= f.recipeID %>">
                <button class="btn btn-sm btn-outline-danger">Remove</button>
              </form>
            <% } %>
          </li>
        <% }) %>
      <% } %>
    </ul>
  </div>

  <%- include('partials/foot.ejs') %>
</body>
</html>
